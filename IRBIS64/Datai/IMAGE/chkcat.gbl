0
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
 v991^A - значение поля 920 для записи WORK

//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
 v991^G - ИМЯ БД каталога

//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
 v991^B - признак кор-ки 0 - не кор-ть, 1 - кор-ть запись каталога

DEL
1910
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ADD
1910
XXXXXXXXXXXXXXXXXXX
if v991^B='1' then (v910/) else (if p(v910) then if v910^A='1' or v910^A='U' and val(v910^2)>0 then v910 fi fi/) fi
XXXXXXXXXXXXXXXXXXX
DEFFLD
3000
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
в поле 2106 номер повторения поля 910

DEL
2106
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ADD
2106
XXXXXXXXXXXXXXXXXXX
'0'
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
поле для признаков корректировки записи каталога

DEL
3333
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
цикл по повторениям поля 910

REPEAT
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
REP
2106
1
f(val(v2106)+1,0,0)
XXXXXXXXXXXXXXXXXXX
ADD
3333

'0'

IF
if &unifor('Av1910^A#1')='1' or &unifor('Av1910^A#1')='U' and val(&unifor('Av1910^2#1'))>0 then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
статус - книга на руках 

// проверяю для статуса U соотношение количеств
IF
if &unifor('Av1910^A#1')='U' and val(&unifor('Av1910^2#1'))>0 and val(&unifor('Av1910^1#1'))<val(&unifor('Av1910^2#1')) then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
PUTFLD
'^A',v991^G,'^B',f(val(MFN),0,0),'^C',v903,'^D',if &unifor('Av1910^H#1')<>'' then &unifor('Av1910^H#1') else &unifor('Av1910^B#1') fi,'^FНеверное кол-во со статусом U','^x',v2106
FI
DEL
2000
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ADD
2000
XXXXXXXXXXXXXXXXXXX
&unifor('DRDR,"C=',V903,'",','mfn')
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
 проверка - есть ли должние с этим шифром

IF
if v2000='' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
 нету

PUTFLD
'^A',v991^G,'^B',f(val(MFN),0,0),'^C',v903,,'^D',if &unifor('Av1910^H#1')<>'' then ,&unifor('Av1910^H#1') else if &unifor('Av1910^B#1')<>'' then &unifor('Av1910^B#1') else ' ' fi fi,'^FНет читателя','^x',v2106
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
REP
3333
L
'1'

FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
IF
if v2000<>'' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
есть должник 

// переменная для признака ОК
ADD
111

&unifor('+1')

CORREC
'RDR'
'^A',v991^G,'^B',f(val(MFN),0,0),'^C',v903,'^D',if &unifor('Av1910^H#1')<>'' then &unifor('Av1910^H#1') else &unifor('Av1910^B#1') fi,'^X',v2106
"C="v903

//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
в записи читателя

IF
if p(v40) then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
1040
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ADD
1040
XXXXXXXXXXXXXXXXXXX
(v40/)
XXXXXXXXXXXXXXXXXXX
DEL
2333
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
цикл по повторениям поля 40

REPEAT
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
IF
if v1001^A=&unifor('Av1040^G#1') and v1001^C=&unifor('Av1040^A#1') then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
совпали имя БД и шифры 

ADD
2333
XXXXXXXXXXXXXXXXXXX
'1'
XXXXXXXXXXXXXXXXXXX
IF
if v1001^D=&unifor('Av1040^B#1') or v1001^D=&unifor('Av1040^H#1') then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
совпали инвент номера 

REP
2333
L
'2'
XXXXXXXXXXXXXXXXXXX
IF
if  &unifor('Av1040^F#1'): '*****' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
экземпляр на руках

REP
2333
L
'3'
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
1040
1
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
UNTIL
if p(v1040) then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
проверим совподение по полю 2333

IF
if v2333: '3' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ситуация ОК

ADD
2333

&unifor('+1W1#OK')

FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
IF
if v2333: '2' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
инвентари совпали, статусы нет - в переменную MFN читателя

ADD
2333

&unifor('+1W1#NOK')

ADD
2333

&unifor('+1W2#',f(val(mfn),0,0))

FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
2333
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
1001
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
END
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
// проверка признака ОК
DEL
2333
*


ADD
2333

&unifor('+1R1')

IF
if v2333:'NOK' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
// несогласованные записи
ADD
111

&unifor('+1R2')

PUTFLD
'^A',v991^G,'^B',f(val(MFN),0,0),'^C',v903,'^D',if &unifor('Av1910^H#1')<>'' then &unifor('Av1910^H#1') else &unifor('Av1910^B#1') fi,'^E',v111,'^FНесогласованные записи','^X',v1001^X
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
111
*


FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
IF
if v2333='' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
// не найден экземпляр
PUTFLD
'^A',v991^G,'^B',f(val(MFN),0,0),'^C',v903,'^D',if &unifor('Av1910^H#1')<>'' then &unifor('Av1910^H#1') else &unifor('Av1910^B#1') fi,'^FНе найден экземпляр ','^x',v2106
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
2333
*


FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
GETFLD
5000



IF
if v5000<>'' then '1' else '0' fi



// корректировка только для статуса 1
IF
if &uf('Av1910^A#1')='1' then if v2106=&unifor('Av5000^X#',&unifor('+N5000')) and &unifor('Av5000^X#',&unifor('+N5000'))<>'' then '1' else '0' fi fi


//
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
это повторение экземпляра следует корректировать

REP
3333
L
'1'

IF
if v991^B='1' then '1' else '0' fi



PUTFLD
'^FСнят признак занятости'



FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
1910
1
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
UNTIL
if p(v1910) then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
// 


корректировка каталога, если задано

IF
if v991^B='1' then '1' else '0' fi



REP
910^A
F
(if p(v910) then if v3333='1' and v910^A='1' then '0' else v910^A fi fi/)

FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
GETFLD
4000



IF
if v4000<>'' then '1' else '0' fi
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
NEWMFN
'WORK'
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
ADD
1001
XXXXXXXXXXXXXXXXXXX
(v4000/)
XXXXXXXXXXXXXXXXXXX
ADD
920
XXXXXXXXXXXXXXXXXXX
v991^A
XXXXXXXXXXXXXXXXXXX
END
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
FI
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
4000
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
5000
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
2000
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
3333
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
2106
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
1910
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
DEL
991
*
XXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXX
